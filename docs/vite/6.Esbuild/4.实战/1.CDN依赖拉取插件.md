#

Esbuild åŸç”Ÿä¸æ”¯æŒé€šè¿‡ http ä» cdn æœåŠ¡ä¸Šæ‹‰å–å¯¹åº”çš„ç¬¬ä¸‰æ–¹ä¾èµ–:

```ts
// src/index.jsx
// react-dom çš„å†…å®¹å…¨éƒ¨ä» CDN æ‹‰å–
// è¿™æ®µä»£ç ç›®å‰æ˜¯æ— æ³•è¿è¡Œçš„
import { render } from "https://cdn.skypack.dev/react-dom";
import React from 'https://cdn.skypack.dev/react'

let Greet = () => <h1>Hello, juejin!</h1>;

render(<Greet />, document.getElementById("root"));
```

ç¤ºä¾‹ä»£ç ä¸­æˆ‘ä»¬ç”¨åˆ°äº† Skypack è¿™ä¸ªæä¾› npm ç¬¬ä¸‰æ–¹åŒ… ESM äº§ç‰©çš„ CDN æœåŠ¡, æˆ‘ä»¬å¯ä»¥é€šè¿‡ url æ¥æŸ¥çœ‹ç¬¬ä¸‰æ–¹åŒ…çš„å†…å®¹

ç°åœ¨æˆ‘ä»¬éœ€è¦é€šè¿‡Esbuildæ’ä»¶æ¥è¯†åˆ«è¿™æ ·çš„urlè·¯å¾„,ç„¶åä»ç½‘ç»œä¸Šè·å–æ¨¡å—å†…å®¹å¹¶è®© Esbuild è¿›è¡ŒåŠ è½½, ç”šè‡³ä¸åœ¨éœ€è¦ `npm install` å®‰è£…ä¾èµ–äº†,
è¿™çœ‹ä¸Šå»æ˜¯ä¸æ˜¯å¾ˆé…·

> é¡ºä¾¿æä¸€å¥ï¼ŒESM CDN ä½œä¸ºé¢å‘æœªæ¥çš„å‰ç«¯åŸºç¡€è®¾æ–½ï¼Œå¯¹ Vite çš„å½±å“ä¹Ÿè‡³å…³é‡å¤§ï¼Œå¯ä»¥æå¤§æå‡ Vite åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹çš„æ„å»ºæ€§èƒ½ã€‚

## å¼€æ•´

```js
// http-import-plugin.js
module.exports = () => ({
  name: "esbuild:http",
  setup(build) {
    let https = require("https");
    let http = require("http");

    // 1. æ‹¦æˆª CDN è¯·æ±‚
    build.onResolve({ filter: /^https?:\/\// }, (args) => ({
      path: args.path,
      namespace: "http-url",
    }));

    // 2. é€šè¿‡ fetch è¯·æ±‚åŠ è½½ CDN èµ„æº
    build.onLoad({ filter: /.*/, namespace: "http-url" }, async (args) => {
      let contents = await new Promise((resolve, reject) => {
        function fetch(url) {
          console.log(`Downloading: ${url}`);
          let lib = url.startsWith("https") ? https : http;
          let req = lib
            .get(url, (res) => {
              if ([301, 302, 307].includes(res.statusCode)) {
                // é‡å®šå‘
                fetch(new URL(res.headers.location, url).toString());
                req.abort();
              } else if (res.statusCode === 200) {
                // å“åº”æˆåŠŸ
                let chunks = [];
                res.on("data", (chunk) => chunks.push(chunk));
                res.on("end", () => resolve(Buffer.concat(chunks)));
              } else {
                reject(
                  new Error(`GET ${url} failed: status ${res.statusCode}`)
                );
              }
            })
            .on("error", reject);
        }
        fetch(args.path);
      });
      return { contents };
    });
  },
});
```

```js
// build.js
const { build } = require("esbuild");
const httpImport = require("./http-import-plugin");
async function runBuild() {
  build({
    absWorkingDir: process.cwd(),
    entryPoints: ["./src/index.jsx"],
    outdir: "dist",
    bundle: true,
    format: "esm",
    splitting: true,
    sourcemap: true,
    metafile: true,
    plugins: [httpImport()],
  }).then(() => {
    console.log("ğŸš€ Build Finished!");
  });
}

runBuild();
```

ç„¶åé€šè¿‡ `node build.js` æ‰§è¡Œæ‰“åŒ…è„šæœ¬, å‘ç°æŠ¥é”™äº†:

![å‘ç°æŠ¥é”™äº†](https://phsdevoss.eheren.com/pcloud/phs3.0/test/Snipaste_2023-04-17_14-35-42.jpg)

è¿™æ—¶æˆ‘ä»¬å¯ä»¥å›å¤´è§‚å¯Ÿç¬¬ä¸‰æ–¹åŒ…çš„å“åº”å†…å®¹:

```js
export * from '/-/react-dom@v17.0.1-oZ1BXZ5opQ1DbTh7nu9r/dist=es2019,mode=imports/optimized/react-dom.js';
export {default} from '/-/react-dom@v17.0.1-oZ1BXZ5opQ1DbTh7nu9r/dist=es2019,mode=imports/optimized/react-dom.js';
```

è¿›ä¸€æ­¥çœ‹è¿˜æœ‰æ›´å¤šå†…å®¹:

![å‘ç°æŠ¥é”™äº†](https://phsdevoss.eheren.com/pcloud/phs3.0/test/Snipaste_2023-04-18_09-58-06.jpg)

å› æ­¤å¯ä»¥å¾—å‡ºç»“è®º, é™¤äº†è¦è§£æ react-dom è¿™ç§ç›´æ¥ä¾èµ–çš„è·¯å¾„, è¿˜è¦è§£æå®ƒä¾èµ–çš„è·¯å¾„, ä¹Ÿå°±æ˜¯é—´æ¥ä¾èµ–è·¯å¾„

è¿™æ—¶å€™å¯ä»¥åŠ å…¥è¿™æ ·ä¸€æ®µ`onResolve`é’©å­:

```ts
// æ‹¦æˆªé—´æ¥ä¾èµ–çš„è·¯å¾„ï¼Œå¹¶é‡å†™è·¯å¾„
// tip: é—´æ¥ä¾èµ–åŒæ ·ä¼šè¢«è‡ªåŠ¨å¸¦ä¸Š `http-url`çš„ namespace
build.onResolve({ filter: /.*/, namespace: "http-url" }, (args) => ({
  // é‡å†™è·¯å¾„
  path: new URL(args.path, args.importer).toString(),
  namespace: "http-url",
}));
```

ç°åœ¨æˆ‘ä»¬å†æ¬¡æ‰§è¡Œnode build.jsï¼Œå‘ç°ä¾èµ–å·²ç»æˆåŠŸä¸‹è½½å¹¶æ‰“åŒ…äº†ã€‚

![å‘ç°æŠ¥é”™äº†](https://phsdevoss.eheren.com/pcloud/phs3.0/test/Snipaste_2023-04-18_10-01-29.jpg)
